name: Track Upstream CHANGELOG

on:
  schedule:
    # Check CHANGELOG every 6 hours
    - cron: '0 */6 * * *'
  workflow_dispatch:
    inputs:
      force_build:
        description: 'Force a build from master regardless of CHANGELOG'
        required: false
        type: boolean
      override_version:
        description: 'Manually set version to record (e.g. 5.112.1)'
        required: false
        type: string

permissions:
  contents: write

jobs:
  changelog-check:
    name: Detect new upstream version in CHANGELOG
    runs-on: ubuntu-latest
    outputs:
      new_version: ${{ steps.scan.outputs.new_version }}
      recorded_version: ${{ steps.scan.outputs.recorded_version }}
      effective_version: ${{ steps.scan.outputs.effective_version }}
      force_build: ${{ steps.scan.outputs.force_build }}
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Scan upstream CHANGELOG
        id: scan
        shell: bash
        run: |
          set -euo pipefail
          FORCE_BUILD="${{ inputs.force_build }}"
          OVERRIDE_VERSION="${{ inputs.override_version }}"
          LAST_FILE=".github/last_changelog_version"

          if [[ -n "$OVERRIDE_VERSION" ]]; then
            echo "override provided: $OVERRIDE_VERSION"
          fi

          # Fetch upstream CHANGELOG (raw)
          echo "Fetching upstream CHANGELOG.md..."
          curl -fsSL https://raw.githubusercontent.com/vatesfr/xen-orchestra/master/CHANGELOG.md -o /tmp/CHANGELOG.md

          # Extract top version pattern like: ## **5.112.1** (2025-11-03)
          TOP_LINE=$(grep -E '^## ' /tmp/CHANGELOG.md | head -n1 || true)
          if [[ -z "$TOP_LINE" ]]; then
            echo "No version line found; aborting" >&2
            exit 0
          fi
          # Try to capture between first pair of ** ** if present, else fallback first token
          VERSION=$(echo "$TOP_LINE" | sed -E 's/^##[[:space:]]+\*\*([^*]+)\*\*.*/\1/' )
          if [[ -z "$VERSION" || "$VERSION" == "$TOP_LINE" ]]; then
            VERSION=$(echo "$TOP_LINE" | awk '{print $2}' | tr -d '*')
          fi
          echo "Detected upstream version: $VERSION"

          RECORDED=""
          if [[ -f "$LAST_FILE" ]]; then
            RECORDED=$(cat "$LAST_FILE")
            echo "Previously recorded version: $RECORDED"
          else
            echo "No previously recorded version"
          fi

          EFFECTIVE_VERSION="$VERSION"
          if [[ -n "$OVERRIDE_VERSION" ]]; then
            EFFECTIVE_VERSION="$OVERRIDE_VERSION"
          fi

          NEW_VERSION=""
          if [[ "$EFFECTIVE_VERSION" != "$RECORDED" ]]; then
            NEW_VERSION="$EFFECTIVE_VERSION"
            echo "New version detected (or override): $NEW_VERSION"
          else
            echo "Version unchanged"
          fi

          echo "new_version=$NEW_VERSION" >> "$GITHUB_OUTPUT"
          echo "recorded_version=$RECORDED" >> "$GITHUB_OUTPUT"
          echo "effective_version=$EFFECTIVE_VERSION" >> "$GITHUB_OUTPUT"
          echo "force_build=$FORCE_BUILD" >> "$GITHUB_OUTPUT"

  build-on-change:
    name: Trigger build workflow on CHANGELOG update
    runs-on: ubuntu-latest
    needs: changelog-check
    if: needs.changelog-check.outputs.new_version != '' || needs.changelog-check.outputs.force_build == 'true'
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Record version
        shell: bash
        run: |
          set -euo pipefail
          VERSION="${{ needs.changelog-check.outputs.effective_version }}"
          echo "$VERSION" > .github/last_changelog_version
          git config user.name github-actions
          git config user.email github-actions@github.com
          git add .github/last_changelog_version
          git commit -m "chore: record upstream CHANGELOG version $VERSION" || echo "Nothing to commit"
          git push origin master || true

      - name: Dispatch build workflow
        uses: actions/github-script@v7
        with:
          script: |
            const version = `${{ needs.changelog-check.outputs.effective_version }}`;
            await github.rest.actions.createWorkflowDispatch({
              owner: context.repo.owner,
              repo: context.repo.repo,
              workflow_id: 'build.yml',
              ref: 'master'
            });
            console.log(`Triggered build for upstream version ${version}`);

      - name: Summary
        run: |
          echo "Triggered build for upstream CHANGELOG version: ${{ needs.changelog-check.outputs.effective_version }}" | tee -a $GITHUB_STEP_SUMMARY
